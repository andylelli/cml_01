CML_VERSION:
  type: number
  required: true
  allowed: [2.0]

CASE:
  required: true
  type: object
  fields:

    meta:
      required: true
      type: object
      fields:
        title: { type: string, required: true }
        author: { type: string, required: true }
        license: { type: string, required: true }
        era:
          type: object
          required: true
          fields:
            decade:
              type: string
              required: true
            realism_constraints:
              type: array
              items: string
        setting:
          type: object
          required: true
          fields:
            location: { type: string, required: true }
            institution: { type: string, required: true }
        crime_class:
          type: object
          required: true
          fields:
            category:
              type: string
              allowed: [murder, theft, disappearance, fraud]
            subtype: { type: string, required: true }

    cast:
      required: true
      type: array
      items:
        type: object
        fields:
          name: { type: string, required: true }
          age_range: { type: string, required: true }
          role_archetype: { type: string, required: true }
          relationships:
            type: array
            items: string
          public_persona: { type: string, required: true }
          private_secret: { type: string, required: true }
          motive_seed: { type: string, required: true }
          motive_strength: { type: string, required: true }
          alibi_window: { type: string, required: true }
          access_plausibility: { type: string, required: true }
          opportunity_channels:
            type: array
            items: string
          behavioral_tells:
            type: array
            items: string
          stakes: { type: string, required: true }
          evidence_sensitivity:
            type: array
            items: string
          culprit_eligibility:
            type: string
            allowed: [eligible, ineligible, locked]
          culpability:
            type: string
            allowed: [guilty, innocent, unknown]

    culpability:
      required: true
      type: object
      fields:
        culprit_count:
          type: number
          required: true
          allowed: [1, 2]
        culprits:
          type: array
          required: true
          items: string

    surface_model:
      required: true
      type: object
      fields:
        narrative:
          type: object
          fields:
            summary: { type: string, required: true }
        accepted_facts:
          type: array
          items: string
          required: true
        inferred_conclusions:
          type: array
          items: string
          required: true

    hidden_model:
      required: true
      type: object
      fields:
        mechanism:
          type: object
          required: true
          fields:
            description: { type: string, required: true }
            delivery_path:
              type: array
              items:
                type: object
                fields:
                  step: { type: string, required: true }
        outcome:
          type: object
          required: true
          fields:
            result: { type: string, required: true }

    false_assumption:
      required: true
      type: object
      fields:
        statement: { type: string, required: true }
        type:
          type: string
          allowed: [temporal, spatial, identity, behavioral, authority]
        why_it_seems_reasonable: { type: string, required: true }
        what_it_hides: { type: string, required: true }

    constraint_space:
      required: true
      type: object
      fields:
        time:
          type: object
          fields:
            anchors: { type: array, items: string }
            windows: { type: array, items: string }
            contradictions: { type: array, items: string }
        access:
          type: object
          fields:
            actors: { type: array, items: string }
            objects: { type: array, items: string }
            permissions: { type: array, items: string }
        physical:
          type: object
          fields:
            laws: { type: array, items: string }
            traces: { type: array, items: string }
        social:
          type: object
          fields:
            trust_channels: { type: array, items: string }
            authority_sources: { type: array, items: string }

    inference_path:
      required: true
      type: object
      fields:
        steps:
          type: array
          required: true
          items:
            type: object
            fields:
              observation: { type: string, required: true }
              correction: { type: string, required: true }
              effect: { type: string, required: true }

    discriminating_test:
      required: true
      type: object
      fields:
        method:
          type: string
          allowed: [reenactment, trap, constraint_proof, administrative_pressure]
        design: { type: string, required: true }
        knowledge_revealed: { type: string, required: true }
        pass_condition: { type: string, required: true }

    fair_play:
      required: true
      type: object
      fields:
        all_clues_visible: { type: boolean, required: true }
        no_special_knowledge_required: { type: boolean, required: true }
        no_late_information: { type: boolean, required: true }
        reader_can_solve: { type: boolean, required: true }
        explanation: { type: string, required: true }

    quality_controls:
      required: true
      type: object
      fields:
        inference_path_requirements:
          required: true
          type: object
          fields:
            min_steps: { type: number, required: true }
            max_steps: { type: number, required: true }
            require_observation_correction_effect: { type: boolean, required: true }
        clue_visibility_requirements:
          required: true
          type: object
          fields:
            essential_clues_min: { type: number, required: true }
            essential_clues_before_test: { type: boolean, required: true }
            early_clues_min: { type: number, required: true }
            mid_clues_min: { type: number, required: true }
            late_clues_min: { type: number, required: true }
        discriminating_test_requirements:
          required: true
          type: object
          fields:
            timing:
              type: string
              required: true
              allowed: [late_act2, early_act3, mid_act3]
            must_reference_inference_step: { type: boolean, required: true }

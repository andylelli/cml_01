# CML 2.0 Alignment and Agent Design

## CML’s role
- CML is the internal source of truth and always exists for every mystery.
- CML is not the primary user interface; it is hidden by default.
- Pipeline execution requires Azure OpenAI credentials; deterministic fallback artifacts are not produced.

## CML 2.0 schema alignment
Use schema/cml_2_0.schema.yaml. Generated CML must include:
- CML_VERSION = 2.0
- meta, surface_model, hidden_model, false_assumption, constraint_space, inference_path, discriminating_test, fair_play, quality_controls
- false_assumption.type in {temporal, spatial, identity, behavioral, authority}
- discriminating_test.method in {reenactment, trap, constraint_proof, administrative_pressure}
- crime_class.category in {murder, theft, disappearance, fraud}

If additional values are needed, update schema explicitly or normalize to allowed values.

## Sample CML awareness
- Load examples/ at startup.
- Use samples as structural inspiration only (classic crime structure), never copy content or plot.
- Use samples as quality baselines and regression tests.
- Flag and normalize schema deviations if any.
- Use grabber/ instructions to create new open-source seed CMLs before adding to examples/.

## Information access levels (docs must match UI)
- **Level 1 — User (Default):** no raw CML; only friendly projections.
- **Level 2 — Advanced (Opt-in):** read-only CML viewer and export.
- **Level 3 — Expert (Explicit Opt-in):** direct CML editing with full validation and regeneration scope control.

## Agent responsibilities
### Agent 1 — Era & Setting
Outputs era constraints: tech, policing, social norms, travel, communication.
Guardrail: non-empty anachronisms/implausibilities trigger retry and block the pipeline if unresolved.
Uniqueness: prompts include a per-run uniqueness seed (runId/projectId) to encourage varied settings.
Period accuracy: prompts include 2–3 period-accurate anchors (politics, science, current affairs).

### Agent 2 — Cast & Motive
Outputs cast list, secrets, motives, and access plausibility.
Guardrail: non-empty stereotypeCheck triggers retry and blocks the pipeline if unresolved.
Uniqueness: prompts include a per-run uniqueness seed (runId/projectId) to encourage varied casts.

### Agent 2b — Character Profiles (LLM)
Generates rich psychological profiles from the cast (post-CML) including:
- Public persona and private secrets
- Personality traits and voice hints (formal vs informal, class-based speech patterns)
- 4-6 narrative paragraphs per character (~1000 words)
- Validates against character_profiles.schema.yaml
- Must not introduce new facts beyond cast/CML
- Used by Agent 9 to create distinct character voices and dialogue patterns

### Agent 2c — Location Profiles (LLM)
Generates comprehensive location profiles including:
- Primary location with geographic specificity (place, country)
- Key locations with full sensory palettes (sights, sounds, smells, tactile)
- Atmospheric context (mood, weather, era markers)
- 3-6 paragraphs per location
- Validates against location_profiles.schema.yaml
- Used by Agent 9 for scene-setting and sensory immersion

### Agent 2d — Temporal Context (LLM)
Generates rich temporal/cultural context including:
- Specific date (month + year) and season
- Period fashion (formal/casual/accessories for men and women)
- Cultural touchstones (music, films, theater, prices)
- Current affairs and social attitudes
- Atmospheric details for the specific time period
- Validates against temporal_context.schema.yaml
- Used by Agent 9 for period authenticity and cultural references

### Agent 2e — Background Context (LLM)
Generates a dedicated `background_context` artifact before CML generation:
- Canonical backdrop summary (era + setting + mood coherence)
- Era/social-structure anchor for scene grounding
- Setting anchor (location/institution/weather)
- Cast anchors (existing cast names only; no new names)
- Theme carry-through for narrative backdrop consistency
- Validates against background_context.schema.yaml
- Consumed by Agent 3 separately from hard-logic ideation

### Agent 3 — Crime Designer (CML generator)
Produces a full CML 2.0-compliant draft that is novel and not traceable to any single seed.
Uses seed CMLs for abstract structure patterns only (axis, mechanism families, cadence), never for specific characters, events, or clue chains.
Applies explicit divergence constraints from seed patterns (era/location, method, false assumption, discriminating test) to reduce similarity.
Uses inventive, non-obvious combinations of setting details, false assumptions, access paths, and discriminating tests while staying fair-play and era-accurate.
Consumes the `hard_logic_devices` artifact generated by Agent 3b and grounds the mechanism backbone in one selected (or coherently hybridized) device concept.
Supports escalation directives from theme text:
- `increase difficulty` → multi-step reasoning with fair cognitive misdirection
- `make it brutal` → near-impossible appearance with rigorous timing/geometry logic

### Agent 3b — Hard-Logic Device Ideation
Generates a dedicated `hard_logic_devices` artifact before CML generation.
Output includes 3–5 novel device concepts with required fields:
- title
- core principle + principle type (physical law, mathematical principle, cognitive bias, social logic)
- surface illusion vs underlying reality
- fair-play clues
- anti-trope justification
- variation/escalation option

Guardrail: artifact must pass schema validation (`hard_logic_devices.schema.yaml`) before Agent 3 proceeds.

### Agent 4 — CML Validator
Validates schema + checklist (validation/VALIDATION_CHECKLIST.md), checks contradictions and fair-play guarantees.
Runs a novelty/similarity audit against selected seeds; if too similar to a single seed, regeneration is required with explicit divergence constraints.

### Agent 5 — Clue & Red Herrings
Derives clue list by category and creates red herrings that support the false assumption without breaking fairness.
Quality loop: if deterministic clue guardrails or fair-play audit fail, Agent 5 regenerates clues once using violations and recommendations.
Guardrails: essential clues are forced to early/mid placement, clue IDs must be unique, and detective-only/private clue phrasing is rejected.

### Agent 6 — Fair Play Auditor
Produces a structured fair-play audit (overall status, checklist items, violations, summary) based on CML + clue distribution.
Missing required fields cause the pipeline to fail fast.
Guardrail: overallStatus of fail or needs-revision triggers a single clue-regeneration pass and re-audit.
Critical fair-play violations (Clue Visibility, Information Parity, No Withholding, Logical Deducibility) now fail the pipeline after retry instead of continuing with warnings.

### Agent 7 — Narrative Outliner
Creates outline with clue placement and discriminating test timing.
Runs a preventive coverage gate before prose to ensure explicit discriminating-test and suspect-elimination beats; regenerates outline once with targeted guardrails if needed.

### Agent 8 — Novelty Auditor
Scores similarity vs selected seed CMLs and summarizes novelty risks.
Guardrail: status fail blocks the pipeline.

### Agent 9 — Prose Generator (LLM)
Generates novel-quality prose with full context integration:
- Input: outline + CML + cast + character profiles + location profiles + temporal context
- Output: 3-6 paragraphs per chapter with varied pacing
- Character voice: Distinct speech patterns based on class, role, background (from profiles)
- Sensory immersion: Multi-sensory scene descriptions using location sensory palettes
- Period authenticity: Fashion, cultural references, prices from temporal context
- Geographic grounding: References specific place + country naturally
- Emotional subtext: Hidden secrets and stakes inform character interactions
- Scene-setting: Atmospheric openings with time, weather, lighting, sensory details
- 8 quality requirements: scene-setting, show-don't-tell, varied structure, character-revealing dialogue, sensory immersion, paragraph structure, pacing variation, emotional subtext
- Validates against prose.schema.yaml
- Must not introduce new facts or override CML logic
- Post-generation guardrail detects role-alias identity drift after confession/arrest and triggers a one-time prose regeneration; unresolved drift is surfaced as a warning.
- Validation-guided repair pass: when validation flags missing discriminating-test realization or suspect-elimination/closure gaps, Agent 9 regenerates prose once with explicit guardrails for on-page test execution and suspect ledger closure.

### Prose (LLM) & Game Pack (planned)
Prose is generated from outline + CML + cast using an LLM (implemented). Game pack generation is planned and not yet available without LLM support.

## Schema System
All artifacts validate against YAML schemas in schema/ directory:
- **cml_2_0.schema.yaml** - Core CML structure with place/country fields in meta.setting
- **character_profiles.schema.yaml** - Character psychological profiles
- **location_profiles.schema.yaml** - Location profiles with sensory details and geographic context
- **temporal_context.schema.yaml** - Date, fashion, cultural context
- **background_context.schema.yaml** - Canonical backdrop context for CML grounding
- **hard_logic_devices.schema.yaml** - Novel hard-logic device ideation artifact
- **cast_design.schema.yaml** - Character design and relationships
- **setting_refinement.schema.yaml** - Era constraints
- **narrative_outline.schema.yaml** - Scene-by-scene structure
- **prose.schema.yaml** - Final prose chapters

Validation occurs automatically after artifact generation:
- Errors logged as warnings in pipeline output
- Type-safe accessors (CharacterProfileAccessor, LocationProfileAccessor, TemporalContextAccessor) provide safe field access
- Schemas serve as documentation for all artifact structures

## Validator gates
- Structural integrity
- Axis dominance
- Epistemic integrity
- False assumption test
- Inference path validity
- Discriminating test soundness
- Fair-play guarantees
- Novelty audit vs selected seed CMLs (regenerate if too similar)
- Narrative continuity (including identity-alias continuity after reveal)
- Case transition bridge checks (disappearance→murder)
- Suspect closure ledger coverage and culprit evidence-chain checks
